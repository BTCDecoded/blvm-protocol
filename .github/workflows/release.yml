name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0). If not provided, auto-increments patch from Cargo.toml'
        required: false
        type: string

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  determine-version:
    name: Determine Version
    runs-on: [self-hosted, Linux, X64, builds]
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_tag: ${{ steps.version.outputs.version_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Auto-increment patch version from Cargo.toml
            CURRENT=$(grep -E '^version = ' Cargo.toml | sed -E 's/^version = "([^"]+)".*/\1/')
            if [ -z "$CURRENT" ]; then
              echo "‚ùå Could not determine current version from Cargo.toml"
              exit 1
            fi
            
            # Increment patch version (X.Y.Z -> X.Y.(Z+1))
            MAJOR=$(echo "$CURRENT" | cut -d. -f1)
            MINOR=$(echo "$CURRENT" | cut -d. -f2)
            PATCH=$(echo "$CURRENT" | cut -d. -f3)
            PATCH=$((PATCH + 1))
            VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi
          
          # Remove 'v' prefix if present
          VERSION=$(echo "$VERSION" | sed 's/^v//')
          VERSION_TAG="v${VERSION}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "Releasing version: ${VERSION_TAG}"

  publish:
    name: Publish to crates.io
    needs: determine-version
    runs-on: [self-hosted, Linux, X64, builds]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.88.0
      
      - name: Get latest bllvm-consensus version from crates.io
        id: consensus-version
        run: |
          CONSENSUS_VER=$(cargo search bllvm-consensus --limit 1 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "")
          if [ -z "$CONSENSUS_VER" ]; then
            echo "ERROR: bllvm-consensus not found on crates.io. It must be published first."
            exit 1
          fi
          echo "version=${CONSENSUS_VER}" >> $GITHUB_OUTPUT
          echo "Using bllvm-consensus version: ${CONSENSUS_VER}"
      
      - name: Update Cargo.toml to use crates.io dependencies
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          CONSENSUS_VER="${{ steps.consensus-version.outputs.version }}"
          
          # Update version
          sed -i "s/^version = \".*\"/version = \"${VERSION}\"/" Cargo.toml
          
          # Update bllvm-consensus dependency to use crates.io version
          sed -i 's|bllvm-consensus = {[^}]*}|bllvm-consensus = "'"${CONSENSUS_VER}"'"|g' Cargo.toml
          
          echo "Updated Cargo.toml:"
          echo "  version: ${VERSION}"
          echo "  bllvm-consensus: ${CONSENSUS_VER}"
          grep -E "^(version|bllvm-consensus)" Cargo.toml
      
      - name: Check for crates.io token
        run: |
          if [ -z "${CARGO_REGISTRY_TOKEN:-}" ]; then
            echo "‚ö†Ô∏è  CARGO_REGISTRY_TOKEN not set, skipping crate publication"
            echo "   Set CARGO_REGISTRY_TOKEN secret to enable crate publishing"
            exit 0
          fi
      
      - name: Configure cargo for crates.io
        if: env.CARGO_REGISTRY_TOKEN != ''
        run: |
          cargo login "${CARGO_REGISTRY_TOKEN}"
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      
      - name: Verify package
        if: env.CARGO_REGISTRY_TOKEN != ''
        run: |
          cargo package --list
      
      - name: Dry-run publish
        if: env.CARGO_REGISTRY_TOKEN != ''
        run: |
          cargo publish --dry-run --allow-dirty
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      
      - name: Check if version already exists
        if: env.CARGO_REGISTRY_TOKEN != ''
        id: check-version
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          CRATE_NAME=$(grep -E '^name = ' Cargo.toml | sed -E 's/^name = "([^"]+)".*/\1/')
          
          echo "üîç Checking if ${CRATE_NAME} v${VERSION} already exists on crates.io..."
          
          # Use crates.io API to check if version exists (more reliable than cargo search)
          # The API returns versions in the "versions" array
          # Retry up to 3 times with exponential backoff
          API_RESPONSE=""
          for i in 1 2 3; do
            API_RESPONSE=$(curl -s --max-time 10 "https://crates.io/api/v1/crates/${CRATE_NAME}/versions" 2>/dev/null || echo "")
            if [ -n "$API_RESPONSE" ] && ! echo "$API_RESPONSE" | grep -q '"detail"'; then
              break
            fi
            if [ $i -lt 3 ]; then
              echo "‚ö†Ô∏è  API check attempt $i failed, retrying in $((i*2)) seconds..."
              sleep $((i*2))
            fi
          done
          
          if [ -z "$API_RESPONSE" ] || echo "$API_RESPONSE" | grep -q '"detail"'; then
            echo "‚ö†Ô∏è  Could not check crates.io API (crate may not exist yet), using cargo search as fallback"
            # Fallback to cargo search - check all versions with higher limit
            SEARCH_OUTPUT=$(cargo search "$CRATE_NAME" --limit 100 2>/dev/null || echo "")
            if echo "$SEARCH_OUTPUT" | grep -qE "\"${CRATE_NAME}\".*\"${VERSION}\""; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è  Version ${VERSION} already published for ${CRATE_NAME} (found via cargo search)"
            else
              echo "exists=false" >> $GITHUB_OUTPUT
              echo "‚úÖ Version ${VERSION} not yet published for ${CRATE_NAME} (cargo search)"
            fi
          else
            # Show existing versions for debugging
            echo "üìã Existing versions on crates.io:"
            if command -v jq &> /dev/null; then
              echo "$API_RESPONSE" | jq -r ".versions[].num" | head -5
            else
              echo "$API_RESPONSE" | grep -o '"num":"[^"]*"' | sed 's/"num":"\(.*\)"/\1/' | head -5
            fi
            echo ""
            
            # Parse JSON to check if version exists (using jq if available, or grep as fallback)
            if command -v jq &> /dev/null; then
              VERSION_EXISTS=$(echo "$API_RESPONSE" | jq -r ".versions[] | select(.num == \"${VERSION}\") | .num" | head -1)
              if [ "$VERSION_EXISTS" = "$VERSION" ]; then
                echo "exists=true" >> $GITHUB_OUTPUT
                echo "‚ö†Ô∏è  Version ${VERSION} already published for ${CRATE_NAME} (found via API)"
              else
                echo "exists=false" >> $GITHUB_OUTPUT
                echo "‚úÖ Version ${VERSION} not yet published for ${CRATE_NAME} (API check)"
              fi
            else
              # Fallback: grep for version in JSON
              if echo "$API_RESPONSE" | grep -q "\"num\":\"${VERSION}\""; then
                echo "exists=true" >> $GITHUB_OUTPUT
                echo "‚ö†Ô∏è  Version ${VERSION} already published for ${CRATE_NAME} (found via grep)"
              else
                echo "exists=false" >> $GITHUB_OUTPUT
                echo "‚úÖ Version ${VERSION} not yet published for ${CRATE_NAME} (grep check)"
              fi
            fi
          fi
          
          echo ""
          echo "üìä Version check result: ${{ steps.check-version.outputs.exists }}"
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      
      - name: Publish to crates.io
        if: env.CARGO_REGISTRY_TOKEN != ''
        id: publish
        continue-on-error: true
        run: |
          set +e
          VERSION="${{ needs.determine-version.outputs.version }}"
          CRATE_NAME=$(grep -E '^name = ' Cargo.toml | sed -E 's/^name = "([^"]+)".*/\1/')
          
          echo "üîç Publish Debug Info:"
          echo "  Version: ${VERSION}"
          echo "  Crate: ${CRATE_NAME}"
          echo "  Version exists check: ${{ steps.check-version.outputs.exists }}"
          
          # Skip if version already exists
          if [ "${{ steps.check-version.outputs.exists }}" = "true" ]; then
            echo "‚ö†Ô∏è  Version ${VERSION} already exists on crates.io, skipping publish"
            echo "published=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo ""
          echo "üì¶ Publishing ${CRATE_NAME} v${VERSION} to crates.io..."
          echo "Running: cargo publish --token [REDACTED] --allow-dirty"
          
          PUBLISH_OUTPUT=$(cargo publish --token "${CARGO_REGISTRY_TOKEN}" --allow-dirty 2>&1)
          PUBLISH_EXIT_CODE=$?
          
          echo ""
          echo "üìã Publish Output:"
          echo "$PUBLISH_OUTPUT"
          echo ""
          
          if [ $PUBLISH_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Successfully published ${CRATE_NAME} v${VERSION}"
            echo "published=true" >> $GITHUB_OUTPUT
            echo "Waiting 30 seconds for crates.io to index..."
            sleep 30
            echo "‚úÖ Publish complete - version should be available on crates.io"
          else
            # Check if error is due to version already existing
            if echo "$PUBLISH_OUTPUT" | grep -qi "already exists"; then
              echo "‚ö†Ô∏è  Version ${VERSION} already exists on crates.io (detected during publish)"
              echo "published=false" >> $GITHUB_OUTPUT
              # Update exists status since we confirmed it exists
              echo "exists=true" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "‚ùå Failed to publish ${CRATE_NAME} v${VERSION}"
              echo "Exit code: $PUBLISH_EXIT_CODE"
              echo "Error output:"
              echo "$PUBLISH_OUTPUT"
              echo ""
              echo "‚ö†Ô∏è  Publish failed - check error output above"
              echo "published=false" >> $GITHUB_OUTPUT
              # Don't exit with error code - let workflow continue
              exit 0
            fi
          fi
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  create-release:
    name: Create GitHub Release
    needs: [determine-version, publish]
    runs-on: [self-hosted, Linux, X64, builds]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create git tag
        run: |
          VERSION_TAG="${{ needs.determine-version.outputs.version_tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if tag already exists
          if git rev-parse "$VERSION_TAG" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Tag ${VERSION_TAG} already exists, skipping tag creation"
          else
            git tag -a "$VERSION_TAG" -m "Release ${VERSION_TAG}"
            git push origin "$VERSION_TAG"
            echo "‚úÖ Created and pushed tag ${VERSION_TAG}"
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.determine-version.outputs.version_tag }}
          name: Release ${{ needs.determine-version.outputs.version_tag }}
          body: |
            ## ${{ needs.determine-version.outputs.version_tag }}
            
            Automated release of bllvm-protocol.
            
            **Published to crates.io**: ${{ needs.publish.result == 'success' && '‚úÖ Yes' || '‚ùå No (check CARGO_REGISTRY_TOKEN)' }}
            
            ### Changes
            See [commit history](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

